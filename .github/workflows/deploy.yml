name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            REPO_DIR="/opt/kleinanzeigen-parser"

            # Ensure base directory exists with proper permissions
            sudo mkdir -p "$REPO_DIR"
            sudo chown -R "$USER":"$USER" "$REPO_DIR" || true
            
            cd "$REPO_DIR"
            
            # Initialize git repo if not present
            if [ ! -d ".git" ]; then
              echo "ğŸ“¦ First-time setup: initializing git repo"
              git init
              git remote add origin https://github.com/${{ github.repository }} || true
            fi
            
            # Fetch and reset to latest main
            echo "ğŸ“¥ Fetching latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # Ensure Docker is installed
            if ! command -v docker >/dev/null 2>&1; then
              echo "ğŸ³ Docker not found. Installing..."
              if command -v apt-get >/dev/null 2>&1; then
                export DEBIAN_FRONTEND=noninteractive
                apt-get update -y
                apt-get install -y ca-certificates curl gnupg lsb-release
                install -m 0755 -d /etc/apt/keyrings || true
                if [ ! -f /etc/apt/keyrings/docker.gpg ]; then
                  curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                  chmod a+r /etc/apt/keyrings/docker.gpg
                fi
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$(. /etc/os-release; echo \"$ID\") $(. /etc/os-release; echo \"$VERSION_CODENAME\") stable" > /etc/apt/sources.list.d/docker.list
                apt-get update -y
                apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                systemctl enable docker || true
                systemctl start docker || true
              elif command -v yum >/dev/null 2>&1; then
                yum install -y yum-utils
                yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
                yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                systemctl enable docker || true
                systemctl start docker || true
              else
                echo "âŒ Docker not found and package manager not supported (need apt or yum)."; exit 1
              fi
            fi

            # Determine compose command and create function
            if docker compose version >/dev/null 2>&1; then
              dc_cmd() { docker compose "$@"; }
            elif command -v docker-compose >/dev/null 2>&1; then
              dc_cmd() { docker-compose "$@"; }
            else
              echo "âš ï¸ docker compose not found. Trying to install compose plugin..."
              if command -v apt-get >/dev/null 2>&1; then
                apt-get update -y && apt-get install -y docker-compose-plugin || true
                if docker compose version >/dev/null 2>&1; then
                  dc_cmd() { docker compose "$@"; }
                else
                  echo "âŒ docker compose still not available."; exit 1
                fi
              else
                echo "âŒ docker compose not available and cannot auto-install here."; exit 1
              fi
            fi

            # dc_cmd function is set above to call either 'docker compose' or 'docker-compose'

            echo "ğŸ›‘ Stopping containers..."
            dc_cmd -f docker-compose.yml down || true

            echo "ğŸ”¨ Building image..."
            dc_cmd -f docker-compose.yml build --no-cache miniapp

            echo "ğŸš€ Starting containers..."
            dc_cmd -f docker-compose.yml up -d miniapp

            echo "â³ Waiting for startup..."
            sleep 5

            echo "âœ… Checking container status..."
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | (grep miniapp || true)

            echo "ğŸ“ Recent logs:"
            docker logs miniapp --tail 50 || true

            # Warn if env file is missing
            if [ ! -f "$REPO_DIR/.env.miniapp" ]; then
              echo "âš ï¸ WARNING: .env.miniapp not found in $REPO_DIR â€” container may not have required env vars"
            fi

            echo "âœ… Deployment completed!"
