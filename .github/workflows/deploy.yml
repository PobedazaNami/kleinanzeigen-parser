name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            REPO_DIR="/opt/kleinanzeigen-parser"

            # Ensure base directory exists with proper permissions
            sudo mkdir -p "$REPO_DIR"
            sudo chown -R "$USER":"$USER" "$REPO_DIR" || true
            
            cd "$REPO_DIR"
            
            # Initialize git repo if not present
            if [ ! -d ".git" ]; then
              echo "ğŸ“¦ First-time setup: initializing git repo"
              git init
              git remote add origin https://github.com/${{ github.repository }} || true
            fi
            
            # Fetch and reset to latest main
            echo "ğŸ“¥ Fetching latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # Compose command (v2 or v1)
            if docker compose version >/dev/null 2>&1; then
              DC="docker compose"
            else
              DC="docker-compose"
            fi

            echo "ğŸ›‘ Stopping containers..."
            $DC -f docker-compose.yml down || true

            echo "ğŸ”¨ Building image..."
            $DC -f docker-compose.yml build --no-cache miniapp

            echo "ğŸš€ Starting containers..."
            $DC -f docker-compose.yml up -d miniapp

            echo "â³ Waiting for startup..."
            sleep 5

            echo "âœ… Checking container status..."
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | (grep miniapp || true)

            echo "ğŸ“ Recent logs:"
            docker logs miniapp --tail 50 || true

            # Warn if env file is missing
            if [ ! -f "$REPO_DIR/.env.miniapp" ]; then
              echo "âš ï¸ WARNING: .env.miniapp not found in $REPO_DIR â€” container may not have required env vars"
            fi

            echo "âœ… Deployment completed!"
